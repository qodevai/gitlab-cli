stages:
  - lint
  - test
  - publish

variables:
  UV_NO_SOURCES: "1"
  UV_EXTRA_INDEX_URL: "https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.qodev.ai/api/v4/projects/47/packages/pypi/simple"

default:
  image: python:3.11-slim
  before_script:
    - pip install uv
    - uv sync --all-extras

lint:
  stage: lint
  script:
    - uv run ruff check .
    - uv run ruff format --check .

test:
  stage: test
  script:
    - uv run pytest -v

publish:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
  before_script:
    - pip install uv
  script:
    - uv build
    - uv publish --publish-url "${PACKAGE_REGISTRY_URL}" -u "${PACKAGE_REGISTRY_USER}" -p "${PACKAGE_REGISTRY_TOKEN}"
